<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Absensi SMPN 38 Maluku Tengah</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .guru-card { transition: all 0.3s ease; position: relative; }
        .guru-card:hover { transform: translateY(-3px); }
        .guru-card.disabled { background: #e2e8f0; opacity: 0.7; pointer-events: none; }
        .guru-card.disabled::after { content: '‚úì SUDAH'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-weight: 900; color: #64748b; border: 2px dashed #64748b; padding: 5px 10px; border-radius: 8px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #764ba2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        
        /* Table Styles */
        .rekap-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .rekap-table th { background: #f3f4f6; padding: 10px; text-align: left; font-weight: bold; color: #4b5563; border-bottom: 2px solid #e5e7eb; }
        .rekap-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; color: #374151; }
        .rekap-table tr:hover { background: #f9fafb; }
        .badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; color: white; }

        .btn-delete {
            position: absolute; top: 8px; right: 8px; 
            background: #fee2e2; color: #ef4444; 
            width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer; transition: all 0.2s;
            z-index: 10;
        }
        .btn-delete:hover { background: #ef4444; color: white; transform: scale(1.1); }
    </style>
</head>
<body class="p-4 lg:p-8">

    <script>
        // MASUKKAN URL DEPLOYMENT BARU DI SINI
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI89W5pXV3wvlX3H6-ePAjgXd42a6_rLWWp9NiOg_vLOyOz7ud2XgRckP02GqpAB6DLA/exec"; 
    </script>

    <div id="login-modal" class="modal">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl font-bold mb-2 text-slate-800">üîê Login Kepala Sekolah</h2>
            <p class="text-sm text-slate-500 mb-6">Area terbatas. Silakan masukkan kata sandi.</p>
            <form onsubmit="processLogin(event)">
                <input type="password" id="admin-password" class="w-full p-3 border-2 border-slate-200 rounded-xl mb-4 text-center font-bold text-lg" placeholder="Kata Sandi..." required>
                <div class="flex gap-2">
                    <button type="button" onclick="closeLoginModal()" class="flex-1 py-3 bg-slate-200 rounded-xl font-bold text-slate-600">Batal</button>
                    <button type="submit" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold">Masuk</button>
                </div>
            </form>
        </div>
    </div>

    <div id="rekap-modal" class="modal items-start pt-10 overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-4xl shadow-2xl m-4 relative">
            <button onclick="document.getElementById('rekap-modal').classList.remove('active')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 font-bold text-xl">‚úï</button>
            
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                üìä Laporan Kehadiran
            </h2>

            <div class="flex flex-wrap gap-2 mb-4 bg-slate-100 p-2 rounded-xl w-fit">
                <button onclick="loadRekap('mingguan')" class="filter-btn px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition-all bg-white shadow-sm ring-1 ring-slate-200">üìÖ Minggu Ini</button>
                <button onclick="loadRekap('bulanan')" class="filter-btn px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition-all">üìÜ Bulan Ini</button>
                <button onclick="loadRekap('semester')" class="filter-btn px-4 py-2 rounded-lg text-sm font-bold text-slate-600 hover:bg-white hover:shadow-sm transition-all">üìö Semester Ini</button>
            </div>

            <div id="rekap-loading" class="hidden text-center py-10">
                <div class="loader mx-auto mb-2"></div>
                <p class="text-slate-500 text-sm">Menghitung data...</p>
            </div>

            <div id="rekap-content" class="overflow-x-auto max-h-[60vh] overflow-y-auto custom-scrollbar">
                <table class="rekap-table">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="w-10">No</th>
                            <th>Nama Pegawai</th>
                            <th class="w-16 text-center">Hadir</th>
                            <th class="w-16 text-center">Sakit</th>
                            <th class="w-16 text-center">Izin</th>
                            <th class="w-16 text-center">Alpha</th>
                            <th class="w-20 text-center">Kehadiran</th>
                        </tr>
                    </thead>
                    <tbody id="rekap-body">
                        </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-xs text-slate-500 text-right italic">
                * Data diurutkan berdasarkan persentase kehadiran tertinggi.
            </div>
        </div>
    </div>

    <button onclick="openLoginModal()" id="btn-admin-login" class="fixed top-4 right-4 z-50 bg-white/20 backdrop-blur-md border border-white/40 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-white/30 transition">
        üîí Login Kepsek
    </button>
    
    <div id="admin-indicator" class="fixed top-4 right-4 z-50 hidden bg-green-500 text-white px-4 py-2 rounded-full font-bold shadow-lg flex items-center gap-2">
        <span>üë®‚Äçüè´ Mode Kepsek</span>
        <button onclick="logout()" class="bg-green-700 p-1 rounded-full hover:bg-green-800" title="Keluar">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
    </div>

    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-6">
        <aside class="w-full lg:w-1/3 glass p-6 h-fit flex flex-col gap-4">
            <div class="text-center mb-2">
                <h1 class="text-2xl font-black text-slate-800">SMPN 38</h1>
                <p class="text-sm font-bold text-purple-600 tracking-widest">MALUKU TENGAH</p>
            </div>

            <div id="admin-tools" class="hidden flex-col gap-2">
                <button onclick="tambahPegawai()" class="w-full py-3 bg-indigo-50 text-indigo-700 border border-indigo-200 font-bold rounded-xl hover:bg-indigo-100 transition-all flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    <span>Tambah Pegawai</span>
                </button>
                <button onclick="bukaRekap()" class="w-full py-3 bg-emerald-50 text-emerald-700 border border-emerald-200 font-bold rounded-xl hover:bg-emerald-100 transition-all flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span>Lihat Rekapitulasi</span>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">üìÖ Tanggal</label>
                    <input type="date" id="tgl-absen" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-700" onchange="loadData()">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">üìù Status Kehadiran</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="status" value="Hadir" class="peer sr-only" checked><div class="p-3 text-center border-2 rounded-xl peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-600 font-bold text-sm">Hadir</div></label>
                        <label class="cursor-pointer"><input type="radio" name="status" value="Sakit" class="peer sr-only"><div class="p-3 text-center border-2 rounded-xl peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-600 font-bold text-sm">Sakit</div></label>
                        <label class="cursor-pointer"><input type="radio" name="status" value="Izin" class="peer sr-only"><div class="p-3 text-center border-2 rounded-xl peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-600 font-bold text-sm">Izin</div></label>
                        <label class="cursor-pointer"><input type="radio" name="status" value="Alpha" class="peer sr-only"><div class="p-3 text-center border-2 rounded-xl peer-checked:bg-slate-700 peer-checked:text-white peer-checked:border-slate-800 font-bold text-sm">Alpha</div></label>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">üí¨ Catatan</label>
                    <textarea id="catatan" rows="2" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm" placeholder="Opsional..."></textarea>
                </div>
                <button onclick="simpanAbsen()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span>KIRIM DATA</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                </button>
            </div>
        </aside>

        <main class="w-full lg:w-2/3 glass p-6 min-h-[600px] flex flex-col relative">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-slate-700">Daftar Pegawai</h2>
                    <p class="text-xs text-slate-500" id="total-pegawai-info">Memuat data...</p>
                </div>
                <input type="text" id="cari" onkeyup="renderGrid()" placeholder="Cari nama..." class="p-2 border-2 border-slate-200 rounded-lg text-sm w-40 sm:w-64">
            </div>

            <div id="loading" class="absolute inset-0 bg-white/80 z-20 flex flex-col items-center justify-center rounded-2xl backdrop-blur-sm">
                <div class="loader mb-4"></div>
                <p class="font-bold text-purple-600 animate-pulse">Menghubungkan ke Database...</p>
            </div>

            <div id="grid-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto max-h-[600px] pr-2 pb-4">
                </div>
        </main>
    </div>

    <script>
        // --- VARIABLES ---
        let daftarPegawai = []; 
        let historyData = {};
        let selectedPegawai = null;
        let activeAdminPassword = null; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tgl-absen').valueAsDate = new Date();
            loadData();
        });

        async function loadData() {
            const date = document.getElementById('tgl-absen').value;
            const loader = document.getElementById('loading');
            
            if(SCRIPT_URL.includes("YOUR_ID")) {
                loader.innerHTML = `<p class="text-red-500 font-bold p-4 text-center">‚ö†Ô∏è Masukkan URL Script Deployment Baru!</p>`;
                return;
            }

            loader.classList.remove('hidden');

            try {
                const [resHistory, resPegawai] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=check&date=${date}`).then(r => r.json()),
                    fetch(`${SCRIPT_URL}?action=getPegawai`).then(r => r.json())
                ]);

                historyData = resHistory.history || {};
                
                if (resPegawai.status === 'success') {
                    daftarPegawai = resPegawai.data;
                    document.getElementById('total-pegawai-info').innerText = `Total: ${daftarPegawai.length} Orang`;
                }
                renderGrid();
            } catch (err) {
                console.error(err);
                Swal.fire('Koneksi Error', 'Gagal memuat data.', 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            const keyword = document.getElementById('cari').value.toLowerCase();
            container.innerHTML = '';

            daftarPegawai.forEach(nama => {
                if(nama.toLowerCase().includes(keyword)) {
                    const status = historyData[nama] ? historyData[nama].status : null;
                    const isDisabled = status ? 'disabled' : '';
                    const isSelected = selectedPegawai === nama ? 'border-purple-500 ring-2 ring-purple-200 bg-purple-50' : 'border-slate-100 bg-white';
                    
                    const deleteBtn = activeAdminPassword 
                        ? `<div onclick="hapusPegawai('${nama}', event)" class="btn-delete" title="Hapus Pegawai">‚úï</div>` 
                        : '';

                    const html = `
                        <div onclick="pilihPegawai('${nama}')" class="guru-card ${isDisabled} ${isSelected} cursor-pointer p-4 border-2 rounded-2xl hover:shadow-md transition-all relative overflow-hidden group">
                            ${deleteBtn}
                            <h3 class="font-bold text-slate-700 text-sm mb-1 pr-6">${nama}</h3>
                            <p class="text-xs text-slate-400 font-medium">
                                ${status ? `<span class="text-emerald-600 font-bold">Status: ${status}</span>` : 'Belum Absen'}
                            </p>
                            ${selectedPegawai === nama && !status ? '<div class="absolute bottom-2 right-2 w-2 h-2 bg-purple-500 rounded-full"></div>' : ''}
                        </div>
                    `;
                    container.innerHTML += html;
                }
            });
        }

        function pilihPegawai(nama) {
            if (historyData[nama]) return; 
            selectedPegawai = nama;
            renderGrid();
        }

        // --- AUTH & ADMIN TOOLS ---
        function openLoginModal() {
            document.getElementById('login-modal').classList.add('active');
            document.getElementById('admin-password').focus();
        }
        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
            document.getElementById('admin-password').value = '';
        }

        function processLogin(e) {
            if(e) e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            const btn = document.querySelector('#login-modal button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = 'Memeriksa...';
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', password: pass })
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    activeAdminPassword = pass;
                    updateAdminUI(true);
                    closeLoginModal();
                    Swal.fire({icon: 'success', title: 'Akses Diterima', text: 'Selamat bekerja, Bapak/Ibu Kepala Sekolah.', timer: 1500, showConfirmButton: false});
                } else {
                    Swal.fire({icon: 'error', title: 'Kata Sandi Salah'});
                }
            })
            .catch(err => Swal.fire('Error', 'Koneksi gagal', 'error'))
            .finally(() => { btn.innerText = originalText; btn.disabled = false; });
        }

        function logout() {
            activeAdminPassword = null;
            updateAdminUI(false);
            Swal.fire({icon: 'info', title: 'Logout Berhasil', timer: 1000, showConfirmButton: false});
        }

        function updateAdminUI(isAdmin) {
            document.getElementById('btn-admin-login').classList.toggle('hidden', isAdmin);
            document.getElementById('admin-indicator').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-indicator').classList.toggle('flex', isAdmin);
            document.getElementById('admin-tools').classList.toggle('hidden', !isAdmin);
            document.getElementById('admin-tools').classList.toggle('flex', isAdmin);
            renderGrid(); 
        }

        // --- REKAPITULASI LOGIC ---
        function bukaRekap() {
            document.getElementById('rekap-modal').classList.add('active');
            loadRekap('mingguan'); // Default load
        }

        function loadRekap(periode) {
            const tbody = document.getElementById('rekap-body');
            const loading = document.getElementById('rekap-loading');
            const content = document.getElementById('rekap-content');
            
            // Highlight button active
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'ring-indigo-300');
                if(btn.innerText.toLowerCase().includes(periode.substring(0,4))) {
                    btn.classList.add('bg-indigo-100', 'text-indigo-700', 'ring-indigo-300');
                }
            });

            content.classList.add('hidden');
            loading.classList.remove('hidden');

            fetch(`${SCRIPT_URL}?action=getRekap&period=${periode}`)
                .then(res => res.json())
                .then(res => {
                    tbody.innerHTML = '';
                    if(res.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-slate-400 py-8">Belum ada data untuk periode ini</td></tr>';
                    }
                    
                    res.data.forEach((item, index) => {
                        let color = 'bg-slate-500';
                        if(item.persen >= 90) color = 'bg-emerald-500';
                        else if(item.persen >= 70) color = 'bg-yellow-500';
                        else color = 'bg-red-500';

                        const html = `
                            <tr>
                                <td class="text-center font-bold text-slate-400">${index + 1}</td>
                                <td class="font-bold text-slate-700">${item.nama}</td>
                                <td class="text-center font-bold text-emerald-600 bg-emerald-50 rounded-lg">${item.h}</td>
                                <td class="text-center font-medium text-red-600">${item.s}</td>
                                <td class="text-center font-medium text-amber-600">${item.i}</td>
                                <td class="text-center font-medium text-slate-600">${item.a}</td>
                                <td class="text-center">
                                    <span class="badge ${color}">${item.persen}%</span>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += html;
                    });
                })
                .catch(err => Swal.fire('Error', 'Gagal memuat rekap', 'error'))
                .finally(() => {
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                });
        }

        // --- CRUD ACTIONS ---
        function simpanAbsen() {
            if (!activeAdminPassword) {
                return Swal.fire({icon: 'warning', title: 'Akses Terbatas', text: 'Login sebagai Kepsek untuk mengisi absen.', confirmButtonColor: '#764ba2', confirmButtonText: 'Login'}).then((r) => { if (r.isConfirmed) openLoginModal(); });
            }
            const date = document.getElementById('tgl-absen').value;
            const status = document.querySelector('input[name="status"]:checked').value;
            const catatan = document.getElementById('catatan').value;
            if (!selectedPegawai) return Swal.fire('Pilih Pegawai', 'Silakan klik nama pegawai di sebelah kanan', 'warning');

            postData({ action: 'simpanAbsen', teacher_name: selectedPegawai, date: date, status: status, notes: catatan, password: activeAdminPassword }, 
                () => { selectedPegawai = null; document.getElementById('catatan').value = ''; loadData(); });
        }

        async function tambahPegawai() {
            const { value: namaBaru } = await Swal.fire({ title: 'Tambah Pegawai', input: 'text', showCancelButton: true, confirmButtonText: 'Simpan', confirmButtonColor: '#764ba2' });
            if (namaBaru) postData({ action: 'tambahPegawai', nama: namaBaru, password: activeAdminPassword }, () => loadData());
        }

        function hapusPegawai(nama, event) {
            event.stopPropagation();
            Swal.fire({ title: 'Hapus?', text: nama, icon: 'warning', showCancelButton: true, confirmButtonText: 'Hapus', confirmButtonColor: '#d33' })
            .then((r) => { if(r.isConfirmed) postData({ action: 'hapusPegawai', nama: nama, password: activeAdminPassword }, () => loadData()); });
        }

        function postData(payload, onSuccess) {
            Swal.fire({title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') { Swal.fire({icon: 'success', title: 'Berhasil', timer: 1000, showConfirmButton: false}); if (onSuccess) onSuccess(); } 
                else { Swal.fire('Gagal', res.message, 'error'); }
            }).catch(err => Swal.fire('Error', 'Gagal koneksi', 'error'));
        }
    </script>
</body>
</html>
